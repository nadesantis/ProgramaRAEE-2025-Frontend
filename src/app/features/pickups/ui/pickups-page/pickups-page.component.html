<div class="page">
  <div class="page-header">
    <h2>Órdenes de Recolección</h2>

    <div class="page-actions">
      <mat-form-field appearance="outline" class="field">
        <mat-label>Estado</mat-label>
        <mat-select [formControl]="status">
          <mat-option value="">(cualquiera)</mat-option>
          <mat-option value="CREATED">Creada</mat-option>
          <mat-option value="APPROVED">Aprobada</mat-option>
          <mat-option value="ASSIGNED">Asignada</mat-option>
          <mat-option value="IN_PROGRESS">En progreso</mat-option>
          <mat-option value="CLOSED">Cerrada</mat-option>
        </mat-select>
      </mat-form-field>

      <button mat-raised-button color="primary" (click)="search()">
        <mat-icon>search</mat-icon>
        Buscar
      </button>

      <button mat-stroked-button (click)="clearFilters()">
        <mat-icon>filter_alt_off</mat-icon>
        Limpiar
      </button>

      <button mat-raised-button color="accent" (click)="newPickup()">
        <mat-icon>add</mat-icon>
        Nueva recolección
      </button>
    </div>
  </div>

  <mat-card class="card">
    <div class="table-scroll">
      <table mat-table [dataSource]="data" class="mat-elevation-z1" multiTemplateDataRows>
        <!-- Cliente -->
        <ng-container matColumnDef="clientName">
          <th mat-header-cell *matHeaderCellDef> Cliente </th>
          <td mat-cell *matCellDef="let row">{{ row.clientName }}</td>
        </ng-container>

        <!-- Técnico -->
        <ng-container matColumnDef="technicianName">
          <th mat-header-cell *matHeaderCellDef> Técnico </th>
          <td mat-cell *matCellDef="let row">{{ row.technicianName || '—' }}</td>
        </ng-container>

        <!-- Estado -->
        <ng-container matColumnDef="status">
          <th mat-header-cell *matHeaderCellDef> Estado </th>
          <td mat-cell *matCellDef="let row">
            <span [class]="statusClass(row.status)">{{ row.statusDisplay }}</span>
          </td>
        </ng-container>

        <!-- Fecha solicitada -->
        <ng-container matColumnDef="requestedAt">
          <th mat-header-cell *matHeaderCellDef> Solicitada </th>
          <td mat-cell *matCellDef="let row">{{ row.requestedAtDisplay }}</td>
        </ng-container>

        <!-- Ubicación -->
        <ng-container matColumnDef="location">
          <th mat-header-cell *matHeaderCellDef> Ubicación </th>
          <td mat-cell *matCellDef="let row">{{ row.location || '—' }}</td>
        </ng-container>

        <!-- Kg RAEE -->
        <ng-container matColumnDef="raeeKg">
          <th mat-header-cell *matHeaderCellDef> Kg RAEE </th>
          <td mat-cell *matCellDef="let row">{{ row.raeeKg ?? '—' }}</td>
        </ng-container>

        <!-- Acciones (contextuales por estado y rol) -->
        <ng-container matColumnDef="actions">
          <th mat-header-cell *matHeaderCellDef> Acciones </th>
          <td mat-cell *matCellDef="let row" class="actions">
            <button
            mat-icon-button
            type="button"
            matTooltip="Aprobar"
            *ngIf="showApprove(row)"
            (click)="approve(row)">
            <mat-icon>check_circle</mat-icon>
          </button>
          

            <button
              mat-icon-button
              matTooltip="Asignar técnico"
              color="primary"
              *ngIf="showAssign(row)"
              (click)="assign(row)"
            >
              <mat-icon>assignment_ind</mat-icon>
            </button>

            <button
              mat-icon-button
              matTooltip="Iniciar"
              color="primary"
              *ngIf="showStart(row)"
              (click)="start(row)"
            >
              <mat-icon>play_circle</mat-icon>
            </button>

            <!-- Dentro de la celda de acciones de cada fila -->
            <button
              mat-icon-button
              matTooltip="Cerrar recolección"
              color="primary"
              *ngIf="showClose(row)"
              (click)="close(row)"
            >
              <mat-icon>done_all</mat-icon>
            </button>

             <button
              mat-icon-button
              matTooltip="Eliminar"
              color="warn"
              *ngIf="showDelete(row)"
              (click)="remove(row)"
            >
              <mat-icon>delete</mat-icon>
            </button>

          </td>           <!-- (opcional) borrar -->

        </ng-container>

        <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
        <tr mat-row *matRowDef="let row; columns: displayedColumns"></tr>
      </table>

      <mat-paginator
        [length]="total"
        [pageIndex]="pageIndex"
        [pageSize]="pageSize"
        (page)="onPaginate($event)"
      ></mat-paginator>
    </div>
  </mat-card>
</div>
